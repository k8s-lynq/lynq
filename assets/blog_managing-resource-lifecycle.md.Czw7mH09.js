import{_ as u,r as s,c as y,o as m,f as a,e as n,a as t,d as l}from"./chunks/plugin-vue_export-helper.BFoZFeGM.js";const D=JSON.parse(`{"title":"5 Kubernetes Lifecycle Mistakes and How Lynq Policies Prevent Them","description":"Real-world problems that occur when managing Kubernetes resources at scale, and how Lynq's policy system prevents them.","frontmatter":{"title":"5 Kubernetes Lifecycle Mistakes and How Lynq Policies Prevent Them","date":"2025-12-18T00:00:00.000Z","author":"Tim Kang","github":"selenehyun","description":"Real-world problems that occur when managing Kubernetes resources at scale, and how Lynq's policy system prevents them.","tags":["Policies","Resource Lifecycle","Kubernetes"],"sidebar":false,"editLink":false,"prev":false,"next":false},"headers":[],"relativePath":"blog/managing-resource-lifecycle.md","filePath":"blog/managing-resource-lifecycle.md","lastUpdated":1771824538000}`),b={name:"blog/managing-resource-lifecycle.md"};function E(g,e,f,w,v,F){const o=s("BlogPostMeta"),p=s("LynqFlowDiagram"),r=s("CreationPolicyVisualizer"),i=s("DeletionPolicyVisualizer"),c=s("ConflictPolicyVisualizer"),d=s("RolloutAnimation"),h=s("BlogPostFooter");return m(),y("div",null,[e[0]||(e[0]=a("h1",{id:"_5-kubernetes-lifecycle-mistakes-and-how-lynq-policies-prevent-them",tabindex:"-1"},[l("5 Kubernetes Lifecycle Mistakes and How Lynq Policies Prevent Them "),a("a",{class:"header-anchor",href:"#_5-kubernetes-lifecycle-mistakes-and-how-lynq-policies-prevent-them","aria-label":'Permalink to "5 Kubernetes Lifecycle Mistakes and How Lynq Policies Prevent Them"'},"​")],-1)),n(o),e[1]||(e[1]=a("p",null,"Managing Kubernetes resources manually works fine at small scale. But when you're managing hundreds of similar resources - like in a multi-tenant SaaS platform - things break in unexpected ways.",-1)),e[2]||(e[2]=a("p",null,"This post covers five real problems that occur when managing resource lifecycles at scale, and how Lynq's policy system prevents each one.",-1)),e[3]||(e[3]=a("h2",{id:"how-lynq-works-quick-overview",tabindex:"-1"},[l("How Lynq Works (Quick Overview) "),a("a",{class:"header-anchor",href:"#how-lynq-works-quick-overview","aria-label":'Permalink to "How Lynq Works (Quick Overview)"'},"​")],-1)),e[4]||(e[4]=a("p",null,"Before diving into the problems, here's a 30-second overview of Lynq:",-1)),n(p),e[5]||(e[5]=t(`<p>Lynq reads data from a database (LynqHub), applies templates (LynqForm) to each row, and creates Kubernetes resources (via LynqNode). When a row is added, resources are created. When a row is deleted, resources are cleaned up.</p><p>Simple enough. But &quot;how&quot; resources are created, updated, and deleted matters enormously at scale.</p><h2 id="problem-1-the-init-job-that-ran-47-times" tabindex="-1">Problem 1: The Init Job That Ran 47 Times <a class="header-anchor" href="#problem-1-the-init-job-that-ran-47-times" aria-label="Permalink to &quot;Problem 1: The Init Job That Ran 47 Times&quot;">​</a></h2><h3 id="what-happened" tabindex="-1">What Happened <a class="header-anchor" href="#what-happened" aria-label="Permalink to &quot;What Happened&quot;">​</a></h3><p>A team set up a database initialization Job in their template:</p><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#85E89D;">jobs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">db-init</span></span>
<span class="line"><span style="color:#85E89D;">    nameTemplate</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-db-init&quot;</span></span>
<span class="line"><span style="color:#85E89D;">    spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">      apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">batch/v1</span></span>
<span class="line"><span style="color:#85E89D;">      kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Job</span></span>
<span class="line"><span style="color:#85E89D;">      spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">        template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">          spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">            containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">init</span></span>
<span class="line"><span style="color:#85E89D;">              image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">postgres:15</span></span>
<span class="line"><span style="color:#85E89D;">              command</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;psql&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;-c&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;CREATE DATABASE app;&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#85E89D;">            restartPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Never</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>The Job ran successfully on the first deployment. Great!</p><p>Then someone updated the template to fix a typo in another resource. The Job ran again. And again. Every template change triggered the Job to run again, attempting to create a database that already existed.</p><p>Over a month, that Job ran 47 times across 200+ tenants.</p><h3 id="the-root-cause" tabindex="-1">The Root Cause <a class="header-anchor" href="#the-root-cause" aria-label="Permalink to &quot;The Root Cause&quot;">​</a></h3><p>By default, Lynq&#39;s <code>creationPolicy</code> is <code>WhenNeeded</code> - resources are reapplied whenever the template changes. This is correct for Deployments that should always reflect the latest spec. But for one-time Jobs, this behavior is catastrophic.</p><h3 id="the-solution-creationpolicy-once" tabindex="-1">The Solution: <code>creationPolicy: Once</code> <a class="header-anchor" href="#the-solution-creationpolicy-once" aria-label="Permalink to &quot;The Solution: \`creationPolicy: Once\`&quot;">​</a></h3><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#85E89D;">jobs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">db-init</span></span>
<span class="line"><span style="color:#85E89D;">    creationPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Once</span><span style="color:#6A737D;">  # Run exactly once, never again</span></span>
<span class="line"><span style="color:#85E89D;">    nameTemplate</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-db-init&quot;</span></span>
<span class="line"><span style="color:#85E89D;">    spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#6A737D;">      # ...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>With <code>Once</code>, Lynq creates the resource on first reconciliation and marks it with a <code>lynq.sh/created-once</code> annotation. Even if the template changes, this resource is never touched again.</p>`,14)),n(r),e[6]||(e[6]=t(`<h3 id="when-to-use-each-policy" tabindex="-1">When to Use Each Policy <a class="header-anchor" href="#when-to-use-each-policy" aria-label="Permalink to &quot;When to Use Each Policy&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Scenario</th><th>Policy</th><th>Why</th></tr></thead><tbody><tr><td>Application Deployment</td><td><code>WhenNeeded</code></td><td>Should always match template</td></tr><tr><td>ConfigMap with settings</td><td><code>WhenNeeded</code></td><td>Settings should stay current</td></tr><tr><td>Database migration Job</td><td><code>Once</code></td><td>Should only run once</td></tr><tr><td>Bootstrap script</td><td><code>Once</code></td><td>Initialization is one-time</td></tr><tr><td>Certificate Secret</td><td><code>Once</code></td><td>Don&#39;t regenerate existing certs</td></tr></tbody></table><h2 id="problem-2-the-customer-data-that-vanished" tabindex="-1">Problem 2: The Customer Data That Vanished <a class="header-anchor" href="#problem-2-the-customer-data-that-vanished" aria-label="Permalink to &quot;Problem 2: The Customer Data That Vanished&quot;">​</a></h2><h3 id="what-happened-1" tabindex="-1">What Happened <a class="header-anchor" href="#what-happened-1" aria-label="Permalink to &quot;What Happened&quot;">​</a></h3><p>A SaaS platform stored customer uploads in PersistentVolumeClaims. When a customer cancelled their subscription, the database row was deleted, which triggered Lynq to clean up all associated resources - including the PVC with 3 years of customer data.</p><p>The customer later renewed their subscription. Their data was gone.</p><h3 id="the-root-cause-1" tabindex="-1">The Root Cause <a class="header-anchor" href="#the-root-cause-1" aria-label="Permalink to &quot;The Root Cause&quot;">​</a></h3><p>By default, Lynq&#39;s <code>deletionPolicy</code> is <code>Delete</code> - when a LynqNode is removed, all associated resources are garbage collected via Kubernetes ownerReferences. This is correct for Deployments and Services, but devastating for data.</p><h3 id="the-solution-deletionpolicy-retain" tabindex="-1">The Solution: <code>deletionPolicy: Retain</code> <a class="header-anchor" href="#the-solution-deletionpolicy-retain" aria-label="Permalink to &quot;The Solution: \`deletionPolicy: Retain\`&quot;">​</a></h3><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#85E89D;">persistentVolumeClaims</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">customer-data</span></span>
<span class="line"><span style="color:#85E89D;">    deletionPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Retain</span><span style="color:#6A737D;">  # Never auto-delete, even if tenant is removed</span></span>
<span class="line"><span style="color:#85E89D;">    nameTemplate</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-data&quot;</span></span>
<span class="line"><span style="color:#85E89D;">    spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">      apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">      kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">PersistentVolumeClaim</span></span>
<span class="line"><span style="color:#85E89D;">      spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">        accessModes</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;ReadWriteOnce&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#85E89D;">        resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">          requests</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">            storage</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">100Gi</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>With <code>Retain</code>, Lynq uses label-based tracking instead of ownerReferences. When the LynqNode is deleted, the resource stays in the cluster with orphan markers:</p><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">  labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">    lynq.sh/orphaned</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#85E89D;">  annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">    lynq.sh/orphaned-at</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;2025-01-15T10:30:00Z&quot;</span></span>
<span class="line"><span style="color:#85E89D;">    lynq.sh/orphaned-reason</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;LynqNodeDeleted&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div>`,12)),n(i),e[7]||(e[7]=t(`<h3 id="managing-orphaned-resources" tabindex="-1">Managing Orphaned Resources <a class="header-anchor" href="#managing-orphaned-resources" aria-label="Permalink to &quot;Managing Orphaned Resources&quot;">​</a></h3><p>Resources with <code>Retain</code> won&#39;t auto-delete, so you need a cleanup process:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># Find all orphaned resources</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> pvc</span><span style="color:#79B8FF;"> -A</span><span style="color:#79B8FF;"> -l</span><span style="color:#9ECBFF;"> lynq.sh/orphaned=</span><span style="color:#79B8FF;">true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Find resources orphaned more than 90 days ago (manual filtering)</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> pvc</span><span style="color:#79B8FF;"> -A</span><span style="color:#79B8FF;"> -l</span><span style="color:#9ECBFF;"> lynq.sh/orphaned=</span><span style="color:#79B8FF;">true</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> json</span><span style="color:#F97583;"> |</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#B392F0;">  jq</span><span style="color:#9ECBFF;"> &#39;.items[] | select(.metadata.annotations[&quot;lynq.sh/orphaned-at&quot;] &lt; &quot;2024-10-01&quot;)&#39;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>Tip:</strong> Set up a scheduled job to review orphaned resources periodically, apply your data retention policy, and delete what&#39;s no longer needed.</p><h2 id="problem-3-the-silent-overwrite-war" tabindex="-1">Problem 3: The Silent Overwrite War <a class="header-anchor" href="#problem-3-the-silent-overwrite-war" aria-label="Permalink to &quot;Problem 3: The Silent Overwrite War&quot;">​</a></h2><h3 id="what-happened-2" tabindex="-1">What Happened <a class="header-anchor" href="#what-happened-2" aria-label="Permalink to &quot;What Happened&quot;">​</a></h3><p>Team A used Lynq to manage application Deployments. Team B manually created a Deployment with the same name for testing. When Lynq reconciled, it silently took over Team B&#39;s Deployment, replacing their test configuration with the template spec.</p><p>Team B spent hours debugging why their changes kept disappearing.</p><h3 id="the-root-cause-2" tabindex="-1">The Root Cause <a class="header-anchor" href="#the-root-cause-2" aria-label="Permalink to &quot;The Root Cause&quot;">​</a></h3><p>With Server-Side Apply&#39;s default behavior, if you apply a resource, you become the owner of the fields you specified. If another system had different values for those fields, yours win.</p><h3 id="the-solution-conflictpolicy-stuck" tabindex="-1">The Solution: <code>conflictPolicy: Stuck</code> <a class="header-anchor" href="#the-solution-conflictpolicy-stuck" aria-label="Permalink to &quot;The Solution: \`conflictPolicy: Stuck\`&quot;">​</a></h3><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#85E89D;">deployments</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app</span></span>
<span class="line"><span style="color:#85E89D;">    conflictPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Stuck</span><span style="color:#6A737D;">  # Stop if someone else owns this resource</span></span>
<span class="line"><span style="color:#85E89D;">    nameTemplate</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-app&quot;</span></span>
<span class="line"><span style="color:#85E89D;">    spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#6A737D;">      # ...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>With <code>Stuck</code> (the default), Lynq detects ownership conflicts and stops reconciliation for that resource. The LynqNode is marked as <code>Degraded</code>, and an event is emitted:</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>ResourceConflict: Resource conflict detected for default/acme-app</span></span>
<span class="line"><span>(Kind: Deployment, Policy: Stuck). Another controller owns this resource.</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div>`,14)),n(c),e[8]||(e[8]=t(`<h3 id="when-to-use-force" tabindex="-1">When to Use <code>Force</code> <a class="header-anchor" href="#when-to-use-force" aria-label="Permalink to &quot;When to Use \`Force\`&quot;">​</a></h3><p>Sometimes you <em>want</em> Lynq to take over. For example, when migrating from another management system:</p><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#85E89D;">deployments</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app</span></span>
<span class="line"><span style="color:#85E89D;">    conflictPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Force</span><span style="color:#6A737D;">  # Take ownership even if someone else has it</span></span>
<span class="line"><span style="color:#85E89D;">    nameTemplate</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-app&quot;</span></span>
<span class="line"><span style="color:#85E89D;">    spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#6A737D;">      # ...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>With <code>Force</code>, Lynq uses Server-Side Apply with <code>force=true</code> to claim ownership. Use this deliberately, not as a default.</p><table tabindex="0"><thead><tr><th>Scenario</th><th>Policy</th><th>Why</th></tr></thead><tbody><tr><td>Normal operation</td><td><code>Stuck</code></td><td>Detect conflicts early</td></tr><tr><td>Migration from Helm/Kustomize</td><td><code>Force</code></td><td>Intentionally taking over</td></tr><tr><td>Shared resources</td><td><code>Stuck</code></td><td>Avoid stepping on others</td></tr><tr><td>Lynq is sole owner</td><td><code>Force</code></td><td>No other controllers involved</td></tr></tbody></table><h2 id="problem-4-the-hpa-that-stopped-working" tabindex="-1">Problem 4: The HPA That Stopped Working <a class="header-anchor" href="#problem-4-the-hpa-that-stopped-working" aria-label="Permalink to &quot;Problem 4: The HPA That Stopped Working&quot;">​</a></h2><h3 id="what-happened-3" tabindex="-1">What Happened <a class="header-anchor" href="#what-happened-3" aria-label="Permalink to &quot;What Happened&quot;">​</a></h3><p>A team configured HorizontalPodAutoscaler to manage their Deployment replicas. Lynq&#39;s template specified <code>replicas: 3</code>. Every time Lynq reconciled, it reset replicas back to 3, fighting the HPA.</p><p>The HPA would scale to 10 replicas under load. Seconds later, Lynq would scale back to 3. The application oscillated wildly.</p><h3 id="the-root-cause-3" tabindex="-1">The Root Cause <a class="header-anchor" href="#the-root-cause-3" aria-label="Permalink to &quot;The Root Cause&quot;">​</a></h3><p>Server-Side Apply tracks field ownership. When Lynq applies a template with <code>replicas: 3</code>, it becomes the owner of that field. When HPA tries to update replicas, there&#39;s a conflict.</p><h3 id="the-solution-patchstrategy-and-field-awareness" tabindex="-1">The Solution: <code>patchStrategy</code> and Field Awareness <a class="header-anchor" href="#the-solution-patchstrategy-and-field-awareness" aria-label="Permalink to &quot;The Solution: \`patchStrategy\` and Field Awareness&quot;">​</a></h3><p><strong>Option 1: Don&#39;t specify replicas in the template</strong></p><p>The simplest fix is to not include the conflicting field:</p><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#85E89D;">deployments</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app</span></span>
<span class="line"><span style="color:#85E89D;">    nameTemplate</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-app&quot;</span></span>
<span class="line"><span style="color:#85E89D;">    spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">      apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">      kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">      spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#6A737D;">        # replicas: 3  # Don&#39;t specify - let HPA manage it</span></span>
<span class="line"><span style="color:#85E89D;">        selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">          matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">            app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp</span></span>
<span class="line"><span style="color:#85E89D;">        template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#6A737D;">          # ...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>Option 2: Use <code>creationPolicy: Once</code></strong></p><p>If you need an initial replica count but want HPA to manage it afterwards:</p><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#85E89D;">deployments</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app</span></span>
<span class="line"><span style="color:#85E89D;">    creationPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Once</span><span style="color:#6A737D;">  # Set initial state, then hands-off</span></span>
<span class="line"><span style="color:#85E89D;">    nameTemplate</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-app&quot;</span></span>
<span class="line"><span style="color:#85E89D;">    spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">      apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">      kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">      spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">        replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3</span><span style="color:#6A737D;">  # Initial value only</span></span>
<span class="line"><span style="color:#6A737D;">        # ...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>Option 3: Use <code>ignoreFields</code> (v1.1.4+)</strong></p><p>For fine-grained control, ignore specific fields during reconciliation:</p><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#85E89D;">deployments</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app</span></span>
<span class="line"><span style="color:#85E89D;">    ignoreFields</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;spec.replicas&quot;</span><span style="color:#6A737D;">  # Ignore this field during updates</span></span>
<span class="line"><span style="color:#85E89D;">    nameTemplate</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-app&quot;</span></span>
<span class="line"><span style="color:#85E89D;">    spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#6A737D;">      # ...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="patchstrategy-options" tabindex="-1">PatchStrategy Options <a class="header-anchor" href="#patchstrategy-options" aria-label="Permalink to &quot;PatchStrategy Options&quot;">​</a></h3><p>Different strategies handle updates differently:</p><table tabindex="0"><thead><tr><th>Strategy</th><th>Behavior</th><th>Use Case</th></tr></thead><tbody><tr><td><code>apply</code> (default)</td><td>Server-Side Apply with field ownership</td><td>Most resources</td></tr><tr><td><code>merge</code></td><td>Strategic merge patch, preserves unspecified fields</td><td>Legacy compatibility</td></tr><tr><td><code>replace</code></td><td>Full replacement, removes unspecified fields</td><td>ConfigMaps needing exact state</td></tr></tbody></table><h2 id="problem-5-the-template-change-that-brought-down-everything" tabindex="-1">Problem 5: The Template Change That Brought Down Everything <a class="header-anchor" href="#problem-5-the-template-change-that-brought-down-everything" aria-label="Permalink to &quot;Problem 5: The Template Change That Brought Down Everything&quot;">​</a></h2><h3 id="what-happened-4" tabindex="-1">What Happened <a class="header-anchor" href="#what-happened-4" aria-label="Permalink to &quot;What Happened&quot;">​</a></h3><p>An engineer updated the container image in a LynqForm template that managed 500 tenants. Within seconds, all 500 Deployments started rolling out simultaneously.</p><p>The container registry couldn&#39;t handle 500 concurrent image pulls. The Kubernetes API server was overwhelmed with update requests. Network bandwidth saturated.</p><p>The new image had a subtle bug. By the time anyone noticed, all 500 tenants were affected.</p><h3 id="the-root-cause-4" tabindex="-1">The Root Cause <a class="header-anchor" href="#the-root-cause-4" aria-label="Permalink to &quot;The Root Cause&quot;">​</a></h3><p>When a LynqForm template changes, Lynq reconciles all LynqNodes using that template. Without rate limiting, this happens all at once.</p><h3 id="the-solution-maxskew" tabindex="-1">The Solution: <code>maxSkew</code> <a class="header-anchor" href="#the-solution-maxskew" aria-label="Permalink to &quot;The Solution: \`maxSkew\`&quot;">​</a></h3><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">lynq.sh/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">LynqHub</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">  name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">production-hub</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">  rollout</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">    maxSkew</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10</span><span style="color:#6A737D;">  # Only 10 nodes updating at any time</span></span>
<span class="line"><span style="color:#85E89D;">  source</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#6A737D;">    # ...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>With <code>maxSkew: 10</code>, Lynq updates at most 10 nodes concurrently. It waits for each batch&#39;s Pods to reach Ready state before starting the next batch.</p>`,34)),n(d),e[9]||(e[9]=t('<h3 id="calculating-maxskew" tabindex="-1">Calculating maxSkew <a class="header-anchor" href="#calculating-maxskew" aria-label="Permalink to &quot;Calculating maxSkew&quot;">​</a></h3><p>Consider your infrastructure capacity:</p><table tabindex="0"><thead><tr><th>Factor</th><th>Consideration</th></tr></thead><tbody><tr><td>Registry bandwidth</td><td>How many concurrent pulls can it handle?</td></tr><tr><td>API server load</td><td>How many concurrent updates?</td></tr><tr><td>Acceptable blast radius</td><td>If new version is buggy, how many tenants can be affected before you notice?</td></tr><tr><td>Rollout time</td><td>500 nodes with maxSkew=10 = 50 batches</td></tr></tbody></table><p><strong>Rule of thumb:</strong> Start with 5-10% of total nodes. For 500 nodes, <code>maxSkew: 25-50</code> gives you time to detect issues before full rollout.</p><p>For a deep dive into how we implemented maxSkew and the edge cases we discovered, see <a href="/blog/maxskew-implementation-lessons.html">Implementing maxSkew: How to Safely Update Nodes at Scale</a>.</p><h2 id="the-five-policies-summary" tabindex="-1">The Five Policies Summary <a class="header-anchor" href="#the-five-policies-summary" aria-label="Permalink to &quot;The Five Policies Summary&quot;">​</a></h2><p>Each problem has a corresponding policy solution:</p><table tabindex="0"><thead><tr><th>Problem</th><th>Default Behavior</th><th>Policy</th><th>Solution Value</th></tr></thead><tbody><tr><td>Init Job runs repeatedly</td><td><code>WhenNeeded</code></td><td><code>creationPolicy: Once</code></td><td>One-time execution</td></tr><tr><td>Data deleted with tenant</td><td><code>Delete</code></td><td><code>deletionPolicy: Retain</code></td><td>Data preservation</td></tr><tr><td>Silent resource overwrite</td><td>Continue</td><td><code>conflictPolicy: Stuck</code></td><td>Conflict detection</td></tr><tr><td>HPA fights with template</td><td>Apply all fields</td><td><code>ignoreFields</code> / <code>patchStrategy</code></td><td>Field-level control</td></tr><tr><td>Blast radius on update</td><td>All at once</td><td><code>maxSkew</code></td><td>Gradual rollout</td></tr></tbody></table><h2 id="key-takeaways" tabindex="-1">Key Takeaways <a class="header-anchor" href="#key-takeaways" aria-label="Permalink to &quot;Key Takeaways&quot;">​</a></h2><ol><li><p><strong>Defaults are optimized for correctness, not safety.</strong> <code>WhenNeeded</code> and <code>Delete</code> make sense for most resources, but can be dangerous for Jobs and data.</p></li><li><p><strong>Think about lifecycle at design time.</strong> Retrofitting policies after an incident is painful. Ask &quot;what should happen when this is deleted?&quot; for every resource.</p></li><li><p><strong>Conflicts are features, not bugs.</strong> <code>Stuck</code> policy makes conflicts visible. Silent overwrites are far worse than explicit failures.</p></li><li><p><strong>Rate limit everything at scale.</strong> Any operation that runs against hundreds of resources needs throttling. <code>maxSkew</code> prevents self-inflicted outages.</p></li><li><p><strong>Test deletion scenarios.</strong> Most teams test creation thoroughly but never test what happens when things are removed.</p></li></ol><hr><p>For complete policy documentation, see <a href="/policies.html">Policies Guide</a>. For more detailed examples with diagrams, see <a href="/policies-examples.html">Policy Examples</a>.</p><p><em>Have you encountered lifecycle issues we didn&#39;t cover? Share your experience on <a href="https://github.com/k8s-lynq/lynq/discussions" target="_blank" rel="noreferrer">GitHub Discussions</a>.</em></p>',13)),n(h)])}const k=u(b,[["render",E]]);export{D as __pageData,k as default};
