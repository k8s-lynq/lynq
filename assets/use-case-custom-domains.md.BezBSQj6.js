import{_ as e,C as o,c as r,o as n,a3 as a,b as c,w as l,a as t,G as i,ag as E}from"./chunks/framework.ZsQ6jjYb.js";const D=JSON.parse('{"title":"Custom Domain Provisioning with External DNS","description":"","frontmatter":{},"headers":[],"relativePath":"use-case-custom-domains.md","filePath":"use-case-custom-domains.md","lastUpdated":1767596577000}'),y={name:"use-case-custom-domains.md"};function u(b,s,m,F,d,B){const p=o("Mermaid");return n(),r("div",null,[s[1]||(s[1]=a('<h1 id="custom-domain-provisioning-with-external-dns" tabindex="-1">Custom Domain Provisioning with External DNS <a class="header-anchor" href="#custom-domain-provisioning-with-external-dns" aria-label="Permalink to &quot;Custom Domain Provisioning with External DNS&quot;">​</a></h1><div class="info custom-block"><p class="custom-block-title">Multi-Tenancy Example</p><p>This guide uses <strong>Multi-Tenancy</strong> (SaaS application with multiple customers) as an example, which is the most common use case for Lynq. The pattern shown here can be adapted for any database-driven infrastructure automation scenario.</p></div><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h2><p>Enable each node to have their own custom domain with automatic DNS and SSL certificate management using <strong>Let&#39;s Encrypt</strong> and <strong>cert-manager</strong>.</p><p><strong>Key Features:</strong></p><ul><li>Automatic DNS record creation via External DNS</li><li>Automatic SSL certificate provisioning with Let&#39;s Encrypt</li><li>Domain verification workflows</li><li>CNAME delegation support</li></ul><h2 id="architecture" tabindex="-1">Architecture <a class="header-anchor" href="#architecture" aria-label="Permalink to &quot;Architecture&quot;">​</a></h2>',7)),(n(),c(E,null,{default:l(()=>[i(p,{id:"mermaid-42",class:"mermaid my-class",graph:"flowchart%20LR%0A%20%20%20%20DB%5B(%22Database%3Cbr%2F%3Enode_id%3Cbr%2F%3Ecustom_domain%3Cbr%2F%3Edomain_verified%22)%5D%0A%0A%20%20%20%20TO%5B%22Lynq%3Cbr%2F%3ECreates%20Ingress%3Cbr%2F%3Eper%20node%22%5D%0A%0A%20%20%20%20ED%5B%22External%20DNS%3Cbr%2F%3ESyncs%20to%3Cbr%2F%3EDNS%20Provider%22%5D%0A%0A%20%20%20%20DNS%5B%22DNS%20Provider%3Cbr%2F%3E(Route53%2FCloudflare)%22%5D%0A%0A%20%20%20%20User%5B%22End%20Users%22%5D%0A%0A%20%20%20%20DB%20--%3E%7CRead%20domains%7C%20TO%0A%20%20%20%20TO%20--%3E%7CCreate%20Ingress%7C%20ED%0A%20%20%20%20ED%20--%3E%7CUpdate%20DNS%7C%20DNS%0A%20%20%20%20User%20--%3E%7CRequest%20custom%20domain%7C%20DNS%0A%20%20%20%20DNS%20--%3E%7CRoute%20traffic%7C%20TO%0A%0A%20%20%20%20style%20DB%20fill%3A%23e3f2fd%2Cstroke%3A%231976d2%2Cstroke-width%3A2px%0A%20%20%20%20style%20TO%20fill%3A%23fff3e0%2Cstroke%3A%23f57c00%2Cstroke-width%3A2px%0A%20%20%20%20style%20ED%20fill%3A%23f3e5f5%2Cstroke%3A%237b1fa2%2Cstroke-width%3A2px%0A%20%20%20%20style%20DNS%20fill%3A%23e8f5e9%2Cstroke%3A%23388e3c%2Cstroke-width%3A2px%0A"})]),fallback:l(()=>[...s[0]||(s[0]=[t(" Loading... ",-1)])]),_:1})),s[2]||(s[2]=a(`<h2 id="database-schema" tabindex="-1">Database Schema <a class="header-anchor" href="#database-schema" aria-label="Permalink to &quot;Database Schema&quot;">​</a></h2><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#F97583;"> TABLE</span><span style="color:#B392F0;"> nodes</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">  node_id </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">63</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">PRIMARY KEY</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  subdomain </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">NOT NULL</span><span style="color:#E1E4E8;">,           </span><span style="color:#6A737D;">-- mycompany.saas.example.com</span></span>
<span class="line"><span style="color:#E1E4E8;">  custom_domain </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">),                </span><span style="color:#6A737D;">-- custom.com</span></span>
<span class="line"><span style="color:#E1E4E8;">  domain_verified </span><span style="color:#F97583;">BOOLEAN</span><span style="color:#F97583;"> DEFAULT</span><span style="color:#E1E4E8;"> FALSE,</span></span>
<span class="line"><span style="color:#E1E4E8;">  cname_target </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">),                 </span><span style="color:#6A737D;">-- What node should CNAME to</span></span>
<span class="line"><span style="color:#E1E4E8;">  is_active </span><span style="color:#F97583;">BOOLEAN</span><span style="color:#F97583;"> DEFAULT</span><span style="color:#E1E4E8;"> TRUE,</span></span>
<span class="line"><span style="color:#E1E4E8;">  plan_type </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">DEFAULT</span><span style="color:#9ECBFF;"> &#39;basic&#39;</span><span style="color:#6A737D;">      -- basic, pro, enterprise</span></span>
<span class="line"><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- Example data</span></span>
<span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> nodes </span><span style="color:#F97583;">VALUES</span></span>
<span class="line"><span style="color:#E1E4E8;">  (</span><span style="color:#9ECBFF;">&#39;acme-corp&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;acme&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;acme.com&#39;</span><span style="color:#E1E4E8;">, TRUE, </span><span style="color:#9ECBFF;">&#39;acme-corp.saas.example.com&#39;</span><span style="color:#E1E4E8;">, TRUE, </span><span style="color:#9ECBFF;">&#39;enterprise&#39;</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">  (</span><span style="color:#9ECBFF;">&#39;startup-x&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;startupx&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;startup-x.com&#39;</span><span style="color:#E1E4E8;">, TRUE, </span><span style="color:#9ECBFF;">&#39;startupx.saas.example.com&#39;</span><span style="color:#E1E4E8;">, TRUE, </span><span style="color:#9ECBFF;">&#39;pro&#39;</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">  (</span><span style="color:#9ECBFF;">&#39;demo-user&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;demo&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">, FALSE, </span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">, TRUE, </span><span style="color:#9ECBFF;">&#39;basic&#39;</span><span style="color:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="lynqhub-configuration" tabindex="-1">LynqHub Configuration <a class="header-anchor" href="#lynqhub-configuration" aria-label="Permalink to &quot;LynqHub Configuration&quot;">​</a></h2><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">operator.lynq.sh/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">LynqHub</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">  name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">domain-enabled-nodes</span></span>
<span class="line"><span style="color:#85E89D;">  namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">lynq-system</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">  source</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">    type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">mysql</span></span>
<span class="line"><span style="color:#85E89D;">    syncInterval</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">1m</span></span>
<span class="line"><span style="color:#85E89D;">    mysql</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">      host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">mysql.database.svc.cluster.local</span></span>
<span class="line"><span style="color:#85E89D;">      port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3306</span></span>
<span class="line"><span style="color:#85E89D;">      database</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nodes_db</span></span>
<span class="line"><span style="color:#85E89D;">      username</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node_reader</span></span>
<span class="line"><span style="color:#85E89D;">      passwordRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">        name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">mysql-credentials</span></span>
<span class="line"><span style="color:#85E89D;">        key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">password</span></span>
<span class="line"><span style="color:#85E89D;">      table</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nodes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D;">  valueMappings</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">    uid</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node_id</span></span>
<span class="line"><span style="color:#6A737D;">    # DEPRECATED v1.1.11+: Use extraValueMappings instead</span></span>
<span class="line"><span style="color:#6A737D;">    #     hostOrUrl: subdomain                    # Default subdomain</span></span>
<span class="line"><span style="color:#85E89D;">    activate</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">is_active</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D;">  extraValueMappings</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">    customDomain</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">custom_domain</span></span>
<span class="line"><span style="color:#85E89D;">    domainVerified</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">domain_verified</span></span>
<span class="line"><span style="color:#85E89D;">    cnameTarget</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cname_target</span></span>
<span class="line"><span style="color:#85E89D;">    planType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">plan_type</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h2 id="prerequisites" tabindex="-1">Prerequisites <a class="header-anchor" href="#prerequisites" aria-label="Permalink to &quot;Prerequisites&quot;">​</a></h2><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># Install cert-manager</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> apply</span><span style="color:#79B8FF;"> -f</span><span style="color:#9ECBFF;"> https://github.com/cert-manager/cert-manager/releases/download/v1.13.2/cert-manager.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Create ClusterIssuer for Let&#39;s Encrypt</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> apply</span><span style="color:#79B8FF;"> -f</span><span style="color:#9ECBFF;"> -</span><span style="color:#F97583;"> &lt;&lt;</span><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"><span style="color:#9ECBFF;">apiVersion: cert-manager.io/v1</span></span>
<span class="line"><span style="color:#9ECBFF;">kind: ClusterIssuer</span></span>
<span class="line"><span style="color:#9ECBFF;">metadata:</span></span>
<span class="line"><span style="color:#9ECBFF;">  name: letsencrypt-prod</span></span>
<span class="line"><span style="color:#9ECBFF;">spec:</span></span>
<span class="line"><span style="color:#9ECBFF;">  acme:</span></span>
<span class="line"><span style="color:#9ECBFF;">    server: https://acme-v02.api.letsencrypt.org/directory</span></span>
<span class="line"><span style="color:#9ECBFF;">    email: admin@example.com</span></span>
<span class="line"><span style="color:#9ECBFF;">    privateKeySecretRef:</span></span>
<span class="line"><span style="color:#9ECBFF;">      name: letsencrypt-prod</span></span>
<span class="line"><span style="color:#9ECBFF;">    solvers:</span></span>
<span class="line"><span style="color:#9ECBFF;">      - http01:</span></span>
<span class="line"><span style="color:#9ECBFF;">          ingress:</span></span>
<span class="line"><span style="color:#9ECBFF;">            class: nginx</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Install External DNS</span></span>
<span class="line"><span style="color:#B392F0;">helm</span><span style="color:#9ECBFF;"> repo</span><span style="color:#9ECBFF;"> add</span><span style="color:#9ECBFF;"> external-dns</span><span style="color:#9ECBFF;"> https://kubernetes-sigs.github.io/external-dns/</span></span>
<span class="line"><span style="color:#B392F0;">helm</span><span style="color:#9ECBFF;"> install</span><span style="color:#9ECBFF;"> external-dns</span><span style="color:#9ECBFF;"> external-dns/external-dns</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#79B8FF;">  --set</span><span style="color:#9ECBFF;"> provider=aws</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#79B8FF;">  --set</span><span style="color:#9ECBFF;"> domainFilters[0]=saas.example.com</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#79B8FF;">  --set</span><span style="color:#9ECBFF;"> policy=sync</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#79B8FF;">  --set</span><span style="color:#9ECBFF;"> registry=txt</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#79B8FF;">  --set</span><span style="color:#9ECBFF;"> txtOwnerId=lynq-cluster</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h2 id="lynqform-configuration" tabindex="-1">LynqForm Configuration <a class="header-anchor" href="#lynqform-configuration" aria-label="Permalink to &quot;LynqForm Configuration&quot;">​</a></h2><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">operator.lynq.sh/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">LynqForm</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">  name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">custom-domain-nodes</span></span>
<span class="line"><span style="color:#85E89D;">  namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">lynq-system</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">  hubId</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">domain-enabled-nodes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  # Create namespace per node for better isolation</span></span>
<span class="line"><span style="color:#85E89D;">  namespaces</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node-namespace</span></span>
<span class="line"><span style="color:#85E89D;">      nameTemplate</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;node-{{ .uid }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">      spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">        apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">        kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Namespace</span></span>
<span class="line"><span style="color:#85E89D;">        metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">          labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">            node-id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">            plan-type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .planType }}&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  # ServiceAccount in node&#39;s namespace</span></span>
<span class="line"><span style="color:#85E89D;">  serviceAccounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-sa</span></span>
<span class="line"><span style="color:#85E89D;">      nameTemplate</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-app&quot;</span></span>
<span class="line"><span style="color:#85E89D;">      targetNamespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;node-{{ .uid }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">      dependIds</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;node-namespace&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#85E89D;">      spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">        apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">        kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ServiceAccount</span></span>
<span class="line"><span style="color:#85E89D;">        metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">          labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">            app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-web&quot;</span></span>
<span class="line"><span style="color:#85E89D;">            node-id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">        automountServiceAccountToken</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  # Main application deployment</span></span>
<span class="line"><span style="color:#85E89D;">  deployments</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">web-app</span></span>
<span class="line"><span style="color:#85E89D;">      nameTemplate</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-web&quot;</span></span>
<span class="line"><span style="color:#85E89D;">      targetNamespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;node-{{ .uid }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">      dependIds</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;node-namespace&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;app-sa&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#85E89D;">      waitForReady</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#85E89D;">      timeoutSeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">600</span></span>
<span class="line"><span style="color:#85E89D;">      spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">        apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">        kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">        metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">          labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">            app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-web&quot;</span></span>
<span class="line"><span style="color:#85E89D;">            node-id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">        spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">          replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#85E89D;">          selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">            matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">              app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-web&quot;</span></span>
<span class="line"><span style="color:#85E89D;">              node-id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">          template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">            metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">              labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">                app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-web&quot;</span></span>
<span class="line"><span style="color:#85E89D;">                node-id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">            spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">              serviceAccountName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-app&quot;</span></span>
<span class="line"><span style="color:#85E89D;">              containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app</span></span>
<span class="line"><span style="color:#85E89D;">                  image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;registry.example.com/node-app:v1.2.3&quot;</span></span>
<span class="line"><span style="color:#85E89D;">                  env</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">NODE_ID</span></span>
<span class="line"><span style="color:#85E89D;">                      value</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">NODE_DOMAIN</span></span>
<span class="line"><span style="color:#85E89D;">                      value</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ if and .customDomain (eq .domainVerified </span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">true</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">) }}{{ .customDomain }}{{ else }}{{ .uid }}.saas.example.com{{ end }}&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">                    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">PLAN_TYPE</span></span>
<span class="line"><span style="color:#85E89D;">                      value</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .planType }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">                  ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                    - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8080</span></span>
<span class="line"><span style="color:#85E89D;">                      name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#85E89D;">                  resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">                    requests</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">                      cpu</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ if eq .planType </span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">enterprise</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;"> }}1000m{{ else if eq .planType </span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">pro</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;"> }}500m{{ else }}200m{{ end }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">                      memory</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ if eq .planType </span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">enterprise</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;"> }}2Gi{{ else if eq .planType </span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">pro</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;"> }}1Gi{{ else }}512Mi{{ end }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">                    limits</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">                      cpu</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ if eq .planType </span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">enterprise</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;"> }}2000m{{ else if eq .planType </span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">pro</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;"> }}1000m{{ else }}400m{{ end }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">                      memory</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ if eq .planType </span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">enterprise</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;"> }}4Gi{{ else if eq .planType </span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">pro</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;"> }}2Gi{{ else }}1Gi{{ end }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">                  livenessProbe</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">                    httpGet</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">                      path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/healthz</span></span>
<span class="line"><span style="color:#85E89D;">                      port</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#85E89D;">                    initialDelaySeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#85E89D;">                    periodSeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#85E89D;">                  readinessProbe</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">                    httpGet</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">                      path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/ready</span></span>
<span class="line"><span style="color:#85E89D;">                      port</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#85E89D;">                    initialDelaySeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5</span></span>
<span class="line"><span style="color:#85E89D;">                    periodSeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  # Service for the deployment</span></span>
<span class="line"><span style="color:#85E89D;">  services</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">web-svc</span></span>
<span class="line"><span style="color:#85E89D;">      nameTemplate</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-web&quot;</span></span>
<span class="line"><span style="color:#85E89D;">      targetNamespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;node-{{ .uid }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">      dependIds</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;web-app&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#85E89D;">      waitForReady</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#85E89D;">      spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">        apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">        kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">        metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">          labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">            app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-web&quot;</span></span>
<span class="line"><span style="color:#85E89D;">            node-id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">        spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">          selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">            app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-web&quot;</span></span>
<span class="line"><span style="color:#85E89D;">            node-id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">          ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#85E89D;">              targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#85E89D;">              name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  # Ingress with default subdomain</span></span>
<span class="line"><span style="color:#85E89D;">  ingresses</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">default-ingress</span></span>
<span class="line"><span style="color:#85E89D;">      nameTemplate</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-default&quot;</span></span>
<span class="line"><span style="color:#85E89D;">      targetNamespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;node-{{ .uid }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">      dependIds</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;web-svc&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#85E89D;">      annotationsTemplate</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">        cert-manager.io/cluster-issuer</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;letsencrypt-prod&quot;</span></span>
<span class="line"><span style="color:#85E89D;">        external-dns.alpha.kubernetes.io/hostname</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}.saas.example.com&quot;</span></span>
<span class="line"><span style="color:#85E89D;">        external-dns.alpha.kubernetes.io/ttl</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;300&quot;</span></span>
<span class="line"><span style="color:#85E89D;">        nginx.ingress.kubernetes.io/ssl-redirect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#85E89D;">        nginx.ingress.kubernetes.io/force-ssl-redirect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#85E89D;">      spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">        apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">        kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="color:#85E89D;">        metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">          labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">            app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-web&quot;</span></span>
<span class="line"><span style="color:#85E89D;">            node-id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">          annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">            cert-manager.io/cluster-issuer</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;letsencrypt-prod&quot;</span></span>
<span class="line"><span style="color:#85E89D;">            external-dns.alpha.kubernetes.io/hostname</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}.saas.example.com&quot;</span></span>
<span class="line"><span style="color:#85E89D;">            external-dns.alpha.kubernetes.io/ttl</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;300&quot;</span></span>
<span class="line"><span style="color:#85E89D;">            nginx.ingress.kubernetes.io/ssl-redirect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#85E89D;">            nginx.ingress.kubernetes.io/force-ssl-redirect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#85E89D;">        spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">          ingressClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#85E89D;">          tls</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">hosts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                - </span><span style="color:#9ECBFF;">&quot;{{ .uid }}.saas.example.com&quot;</span></span>
<span class="line"><span style="color:#85E89D;">              secretName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-default-tls&quot;</span></span>
<span class="line"><span style="color:#85E89D;">          rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}.saas.example.com&quot;</span></span>
<span class="line"><span style="color:#85E89D;">              http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">                paths</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                  - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/</span></span>
<span class="line"><span style="color:#85E89D;">                    pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#85E89D;">                    backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">                      service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">                        name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-web&quot;</span></span>
<span class="line"><span style="color:#85E89D;">                        port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">                          number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">How It Works</p><ul><li><strong>External DNS</strong>: Reads <code>external-dns.alpha.kubernetes.io/hostname</code> annotation and creates DNS records automatically</li><li><strong>cert-manager</strong>: Reads <code>cert-manager.io/cluster-issuer</code> annotation and provisions Let&#39;s Encrypt certificates</li><li><strong>Automatic Renewal</strong>: cert-manager renews certificates 30 days before expiration</li></ul></div><h2 id="custom-domain-support" tabindex="-1">Custom Domain Support <a class="header-anchor" href="#custom-domain-support" aria-label="Permalink to &quot;Custom Domain Support&quot;">​</a></h2><p>For nodes with verified custom domains, add additional Ingress resources:</p><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">  # Custom domain Ingress (for verified domains)</span></span>
<span class="line"><span style="color:#85E89D;">  ingresses</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">custom-ingress</span></span>
<span class="line"><span style="color:#85E89D;">      nameTemplate</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-custom&quot;</span></span>
<span class="line"><span style="color:#85E89D;">      targetNamespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;node-{{ .uid }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">      dependIds</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;web-svc&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#85E89D;">      annotationsTemplate</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">        cert-manager.io/cluster-issuer</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;letsencrypt-prod&quot;</span></span>
<span class="line"><span style="color:#85E89D;">        external-dns.alpha.kubernetes.io/hostname</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .customDomain }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">        external-dns.alpha.kubernetes.io/ttl</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;300&quot;</span></span>
<span class="line"><span style="color:#85E89D;">      spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">        apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">        kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="color:#85E89D;">        metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">          labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">            app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-web&quot;</span></span>
<span class="line"><span style="color:#85E89D;">            node-id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">          annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">            cert-manager.io/cluster-issuer</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;letsencrypt-prod&quot;</span></span>
<span class="line"><span style="color:#85E89D;">            external-dns.alpha.kubernetes.io/hostname</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .customDomain }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">            external-dns.alpha.kubernetes.io/ttl</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;300&quot;</span></span>
<span class="line"><span style="color:#85E89D;">        spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">          ingressClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#85E89D;">          tls</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">hosts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                - </span><span style="color:#9ECBFF;">&quot;{{ .customDomain }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">              secretName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-custom-tls&quot;</span></span>
<span class="line"><span style="color:#85E89D;">          rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .customDomain }}&quot;</span></span>
<span class="line"><span style="color:#85E89D;">              http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">                paths</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                  - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/</span></span>
<span class="line"><span style="color:#85E89D;">                    pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#85E89D;">                    backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">                      service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">                        name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-web&quot;</span></span>
<span class="line"><span style="color:#85E89D;">                        port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">                          number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p><strong>Note:</strong> Filter nodes with verified domains using a database view:</p><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#F97583;"> VIEW</span><span style="color:#B392F0;"> nodes_with_custom_domains</span><span style="color:#F97583;"> AS</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#F97583;"> *</span><span style="color:#F97583;"> FROM</span><span style="color:#E1E4E8;"> nodes </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> custom_domain </span><span style="color:#F97583;">IS NOT NULL</span><span style="color:#F97583;"> AND</span><span style="color:#E1E4E8;"> domain_verified </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> TRUE;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Create a separate LynqHub and Template for custom domains to avoid creating Ingress for unverified domains.</p><h2 id="domain-verification-workflow" tabindex="-1">Domain Verification Workflow <a class="header-anchor" href="#domain-verification-workflow" aria-label="Permalink to &quot;Domain Verification Workflow&quot;">​</a></h2><ol><li><strong>Node Requests Custom Domain</strong>: User enters <code>custom.com</code> in your SaaS portal</li><li><strong>Database Update</strong>: Portal updates <code>nodes.custom_domain</code> but keeps <code>domain_verified=FALSE</code></li><li><strong>CNAME Target Provided</strong>: Show user: &quot;Point CNAME for <code>custom.com</code> to <code>acme-corp.saas.example.com</code>&quot;</li><li><strong>Background Verification</strong>: Your verification service checks DNS periodically</li><li><strong>Mark as Verified</strong>: Once CNAME is detected, update <code>domain_verified=TRUE</code></li><li><strong>Automatic Deployment</strong>: Lynq creates Ingress with cert-manager annotation</li><li><strong>DNS Propagation</strong>: External DNS creates Route53/Cloudflare records</li><li><strong>SSL Certificate</strong>: cert-manager issues Let&#39;s Encrypt certificate via HTTP-01 or DNS-01 challenge</li><li><strong>Certificate Storage</strong>: cert-manager stores certificate in Secret <code>&lt;node&gt;-custom-tls</code></li></ol><h2 id="verification-commands" tabindex="-1">Verification Commands <a class="header-anchor" href="#verification-commands" aria-label="Permalink to &quot;Verification Commands&quot;">​</a></h2><p>Verify each step of the custom domain setup:</p><h3 id="verify-prerequisites" tabindex="-1">Verify Prerequisites <a class="header-anchor" href="#verify-prerequisites" aria-label="Permalink to &quot;Verify Prerequisites&quot;">​</a></h3><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 1. Check cert-manager is running</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> pods</span><span style="color:#79B8FF;"> -n</span><span style="color:#9ECBFF;"> cert-manager</span></span>
<span class="line"><span style="color:#6A737D;"># Expected: cert-manager, cert-manager-cainjector, cert-manager-webhook all Running</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 2. Verify ClusterIssuer is ready</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> clusterissuer</span><span style="color:#9ECBFF;"> letsencrypt-prod</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> jsonpath=&#39;{.status.conditions[?(@.type==&quot;Ready&quot;)].status}&#39;</span></span>
<span class="line"><span style="color:#6A737D;"># Expected: True</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 3. Check External DNS is running</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> pods</span><span style="color:#79B8FF;"> -l</span><span style="color:#9ECBFF;"> app.kubernetes.io/name=external-dns</span></span>
<span class="line"><span style="color:#6A737D;"># Expected: Running</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="verify-default-domain-setup" tabindex="-1">Verify Default Domain Setup <a class="header-anchor" href="#verify-default-domain-setup" aria-label="Permalink to &quot;Verify Default Domain Setup&quot;">​</a></h3><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 1. Check Ingress created for node</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> ingress</span><span style="color:#79B8FF;"> -n</span><span style="color:#9ECBFF;"> node-acme-corp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Expected output:</span></span>
<span class="line"><span style="color:#6A737D;"># NAME                 CLASS   HOSTS                        ADDRESS       PORTS     AGE</span></span>
<span class="line"><span style="color:#6A737D;"># acme-corp-default    nginx   acme-corp.saas.example.com   10.0.0.50     80, 443   5m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 2. Verify TLS certificate created</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> certificate</span><span style="color:#79B8FF;"> -n</span><span style="color:#9ECBFF;"> node-acme-corp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Expected output:</span></span>
<span class="line"><span style="color:#6A737D;"># NAME                   READY   SECRET                   AGE</span></span>
<span class="line"><span style="color:#6A737D;"># acme-corp-default-tls  True    acme-corp-default-tls    5m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 3. Check certificate details</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> describe</span><span style="color:#9ECBFF;"> certificate</span><span style="color:#9ECBFF;"> acme-corp-default-tls</span><span style="color:#79B8FF;"> -n</span><span style="color:#9ECBFF;"> node-acme-corp</span><span style="color:#F97583;"> |</span><span style="color:#B392F0;"> grep</span><span style="color:#79B8FF;"> -A</span><span style="color:#79B8FF;"> 5</span><span style="color:#9ECBFF;"> &quot;Status:&quot;</span></span>
<span class="line"><span style="color:#6A737D;"># Expected: Ready: True, Message: Certificate is up to date and has not expired</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 4. Verify DNS record created</span></span>
<span class="line"><span style="color:#B392F0;">dig</span><span style="color:#9ECBFF;"> acme-corp.saas.example.com</span><span style="color:#9ECBFF;"> @8.8.8.8</span><span style="color:#9ECBFF;"> +short</span></span>
<span class="line"><span style="color:#6A737D;"># Expected: 10.0.0.50 (Ingress LoadBalancer IP)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 5. Test HTTPS access</span></span>
<span class="line"><span style="color:#B392F0;">curl</span><span style="color:#79B8FF;"> -I</span><span style="color:#9ECBFF;"> https://acme-corp.saas.example.com</span></span>
<span class="line"><span style="color:#6A737D;"># Expected: HTTP/2 200 (or 301/302 redirect)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="verify-custom-domain-setup" tabindex="-1">Verify Custom Domain Setup <a class="header-anchor" href="#verify-custom-domain-setup" aria-label="Permalink to &quot;Verify Custom Domain Setup&quot;">​</a></h3><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># After setting domain_verified = TRUE in database:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 1. Check custom domain Ingress created</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> ingress</span><span style="color:#9ECBFF;"> acme-corp-custom</span><span style="color:#79B8FF;"> -n</span><span style="color:#9ECBFF;"> node-acme-corp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Expected output:</span></span>
<span class="line"><span style="color:#6A737D;"># NAME               CLASS   HOSTS        ADDRESS       PORTS     AGE</span></span>
<span class="line"><span style="color:#6A737D;"># acme-corp-custom   nginx   acme.com     10.0.0.50     80, 443   2m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 2. Verify custom domain certificate</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> certificate</span><span style="color:#9ECBFF;"> acme-corp-custom-tls</span><span style="color:#79B8FF;"> -n</span><span style="color:#9ECBFF;"> node-acme-corp</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> jsonpath=&#39;{.status.conditions[?(@.type==&quot;Ready&quot;)].status}&#39;</span></span>
<span class="line"><span style="color:#6A737D;"># Expected: True</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 3. Check certificate covers custom domain</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> secret</span><span style="color:#9ECBFF;"> acme-corp-custom-tls</span><span style="color:#79B8FF;"> -n</span><span style="color:#9ECBFF;"> node-acme-corp</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> jsonpath=&#39;{.data.tls\\.crt}&#39;</span><span style="color:#F97583;"> |</span><span style="color:#B392F0;"> base64</span><span style="color:#79B8FF;"> -d</span><span style="color:#F97583;"> |</span><span style="color:#B392F0;"> openssl</span><span style="color:#9ECBFF;"> x509</span><span style="color:#79B8FF;"> -noout</span><span style="color:#79B8FF;"> -text</span><span style="color:#F97583;"> |</span><span style="color:#B392F0;"> grep</span><span style="color:#9ECBFF;"> &quot;DNS:&quot;</span></span>
<span class="line"><span style="color:#6A737D;"># Expected: DNS:acme.com</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 4. Verify customer&#39;s CNAME is correct</span></span>
<span class="line"><span style="color:#B392F0;">dig</span><span style="color:#9ECBFF;"> acme.com</span><span style="color:#9ECBFF;"> CNAME</span><span style="color:#9ECBFF;"> +short</span></span>
<span class="line"><span style="color:#6A737D;"># Expected: acme-corp.saas.example.com.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 5. Test custom domain access</span></span>
<span class="line"><span style="color:#B392F0;">curl</span><span style="color:#79B8FF;"> -I</span><span style="color:#9ECBFF;"> https://acme.com</span></span>
<span class="line"><span style="color:#6A737D;"># Expected: HTTP/2 200</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="complete-verification-script" tabindex="-1">Complete Verification Script <a class="header-anchor" href="#complete-verification-script" aria-label="Permalink to &quot;Complete Verification Script&quot;">​</a></h3><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">#!/bin/bash</span></span>
<span class="line"><span style="color:#6A737D;"># verify-custom-domain.sh &lt;node-id&gt; &lt;custom-domain&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">NODE_ID</span><span style="color:#F97583;">=</span><span style="color:#FFAB70;">$1</span></span>
<span class="line"><span style="color:#E1E4E8;">CUSTOM_DOMAIN</span><span style="color:#F97583;">=</span><span style="color:#FFAB70;">$2</span></span>
<span class="line"><span style="color:#E1E4E8;">NAMESPACE</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;node-\${</span><span style="color:#E1E4E8;">NODE_ID</span><span style="color:#9ECBFF;">}&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">DEFAULT_DOMAIN</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;\${</span><span style="color:#E1E4E8;">NODE_ID</span><span style="color:#9ECBFF;">}.saas.example.com&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">echo</span><span style="color:#9ECBFF;"> &quot;=== Verifying Custom Domain Setup for \${</span><span style="color:#E1E4E8;">NODE_ID</span><span style="color:#9ECBFF;">} ===&quot;</span></span>
<span class="line"><span style="color:#79B8FF;">echo</span><span style="color:#9ECBFF;"> &quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Check LynqNode status</span></span>
<span class="line"><span style="color:#79B8FF;">echo</span><span style="color:#9ECBFF;"> &quot;1. LynqNode Status:&quot;</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> lynqnode</span><span style="color:#E1E4E8;"> \${NODE_ID}</span><span style="color:#9ECBFF;">-custom-domain-nodes</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> jsonpath=&#39;{.status.conditions[?(@.type==&quot;Ready&quot;)].status}&#39;</span></span>
<span class="line"><span style="color:#79B8FF;">echo</span><span style="color:#9ECBFF;"> &quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Check default Ingress</span></span>
<span class="line"><span style="color:#79B8FF;">echo</span><span style="color:#9ECBFF;"> &quot;2. Default Ingress (\${</span><span style="color:#E1E4E8;">DEFAULT_DOMAIN</span><span style="color:#9ECBFF;">}):&quot;</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> ingress</span><span style="color:#E1E4E8;"> \${NODE_ID}</span><span style="color:#9ECBFF;">-default</span><span style="color:#79B8FF;"> -n</span><span style="color:#E1E4E8;"> \${NAMESPACE} </span><span style="color:#79B8FF;">-o</span><span style="color:#9ECBFF;"> wide</span><span style="color:#F97583;"> 2&gt;</span><span style="color:#9ECBFF;">/dev/null</span><span style="color:#F97583;"> ||</span><span style="color:#79B8FF;"> echo</span><span style="color:#9ECBFF;"> &quot;   Not found&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Check custom Ingress</span></span>
<span class="line"><span style="color:#79B8FF;">echo</span><span style="color:#9ECBFF;"> &quot;3. Custom Ingress (\${</span><span style="color:#E1E4E8;">CUSTOM_DOMAIN</span><span style="color:#9ECBFF;">}):&quot;</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> ingress</span><span style="color:#E1E4E8;"> \${NODE_ID}</span><span style="color:#9ECBFF;">-custom</span><span style="color:#79B8FF;"> -n</span><span style="color:#E1E4E8;"> \${NAMESPACE} </span><span style="color:#79B8FF;">-o</span><span style="color:#9ECBFF;"> wide</span><span style="color:#F97583;"> 2&gt;</span><span style="color:#9ECBFF;">/dev/null</span><span style="color:#F97583;"> ||</span><span style="color:#79B8FF;"> echo</span><span style="color:#9ECBFF;"> &quot;   Not found (domain not verified?)&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Check certificates</span></span>
<span class="line"><span style="color:#79B8FF;">echo</span><span style="color:#9ECBFF;"> &quot;4. TLS Certificates:&quot;</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> certificates</span><span style="color:#79B8FF;"> -n</span><span style="color:#E1E4E8;"> \${NAMESPACE}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Check DNS resolution</span></span>
<span class="line"><span style="color:#79B8FF;">echo</span><span style="color:#9ECBFF;"> &quot;5. DNS Resolution:&quot;</span></span>
<span class="line"><span style="color:#79B8FF;">echo</span><span style="color:#9ECBFF;"> &quot;   Default: $(</span><span style="color:#B392F0;">dig</span><span style="color:#9ECBFF;"> +short \${</span><span style="color:#E1E4E8;">DEFAULT_DOMAIN</span><span style="color:#9ECBFF;">} @8.8.8.8)&quot;</span></span>
<span class="line"><span style="color:#79B8FF;">echo</span><span style="color:#9ECBFF;"> &quot;   Custom:  $(</span><span style="color:#B392F0;">dig</span><span style="color:#9ECBFF;"> +short \${</span><span style="color:#E1E4E8;">CUSTOM_DOMAIN</span><span style="color:#9ECBFF;">} @8.8.8.8)&quot;</span></span>
<span class="line"><span style="color:#79B8FF;">echo</span><span style="color:#9ECBFF;"> &quot;   CNAME:   $(</span><span style="color:#B392F0;">dig</span><span style="color:#9ECBFF;"> +short \${</span><span style="color:#E1E4E8;">CUSTOM_DOMAIN</span><span style="color:#9ECBFF;">} CNAME)&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Check HTTPS connectivity</span></span>
<span class="line"><span style="color:#79B8FF;">echo</span><span style="color:#9ECBFF;"> &quot;6. HTTPS Connectivity:&quot;</span></span>
<span class="line"><span style="color:#79B8FF;">echo</span><span style="color:#9ECBFF;"> &quot;   Default: $(</span><span style="color:#B392F0;">curl</span><span style="color:#79B8FF;"> -s</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> /dev/null </span><span style="color:#79B8FF;">-w</span><span style="color:#9ECBFF;"> &quot;%{http_code}&quot; https://\${</span><span style="color:#E1E4E8;">DEFAULT_DOMAIN</span><span style="color:#9ECBFF;">}/healthz </span><span style="color:#F97583;">2&gt;</span><span style="color:#9ECBFF;">/dev/null </span><span style="color:#F97583;">||</span><span style="color:#79B8FF;"> echo</span><span style="color:#9ECBFF;"> &quot;Failed&quot;)&quot;</span></span>
<span class="line"><span style="color:#79B8FF;">echo</span><span style="color:#9ECBFF;"> &quot;   Custom:  $(</span><span style="color:#B392F0;">curl</span><span style="color:#79B8FF;"> -s</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> /dev/null </span><span style="color:#79B8FF;">-w</span><span style="color:#9ECBFF;"> &quot;%{http_code}&quot; https://\${</span><span style="color:#E1E4E8;">CUSTOM_DOMAIN</span><span style="color:#9ECBFF;">}/healthz </span><span style="color:#F97583;">2&gt;</span><span style="color:#9ECBFF;">/dev/null </span><span style="color:#F97583;">||</span><span style="color:#79B8FF;"> echo</span><span style="color:#9ECBFF;"> &quot;Failed&quot;)&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">echo</span><span style="color:#9ECBFF;"> &quot;&quot;</span></span>
<span class="line"><span style="color:#79B8FF;">echo</span><span style="color:#9ECBFF;"> &quot;=== Verification Complete ===&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>Usage:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">./verify-custom-domain.sh</span><span style="color:#9ECBFF;"> acme-corp</span><span style="color:#9ECBFF;"> acme.com</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Example output:</span></span>
<span class="line"><span style="color:#6A737D;"># === Verifying Custom Domain Setup for acme-corp ===</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># 1. LynqNode Status:</span></span>
<span class="line"><span style="color:#6A737D;"># True</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># 2. Default Ingress (acme-corp.saas.example.com):</span></span>
<span class="line"><span style="color:#6A737D;"># NAME               CLASS   HOSTS                        ADDRESS     PORTS     AGE</span></span>
<span class="line"><span style="color:#6A737D;"># acme-corp-default  nginx   acme-corp.saas.example.com   10.0.0.50   80, 443   1h</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># 3. Custom Ingress (acme.com):</span></span>
<span class="line"><span style="color:#6A737D;"># NAME             CLASS   HOSTS      ADDRESS     PORTS     AGE</span></span>
<span class="line"><span style="color:#6A737D;"># acme-corp-custom nginx   acme.com   10.0.0.50   80, 443   30m</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># 4. TLS Certificates:</span></span>
<span class="line"><span style="color:#6A737D;"># NAME                     READY   SECRET                    AGE</span></span>
<span class="line"><span style="color:#6A737D;"># acme-corp-default-tls    True    acme-corp-default-tls     1h</span></span>
<span class="line"><span style="color:#6A737D;"># acme-corp-custom-tls     True    acme-corp-custom-tls      30m</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># 5. DNS Resolution:</span></span>
<span class="line"><span style="color:#6A737D;">#    Default: 10.0.0.50</span></span>
<span class="line"><span style="color:#6A737D;">#    Custom:  10.0.0.50</span></span>
<span class="line"><span style="color:#6A737D;">#    CNAME:   acme-corp.saas.example.com.</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># 6. HTTPS Connectivity:</span></span>
<span class="line"><span style="color:#6A737D;">#    Default: 200</span></span>
<span class="line"><span style="color:#6A737D;">#    Custom:  200</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># === Verification Complete ===</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="troubleshooting-certificate-issues" tabindex="-1">Troubleshooting Certificate Issues <a class="header-anchor" href="#troubleshooting-certificate-issues" aria-label="Permalink to &quot;Troubleshooting Certificate Issues&quot;">​</a></h3><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># Check certificate request status</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> certificaterequest</span><span style="color:#79B8FF;"> -n</span><span style="color:#9ECBFF;"> node-acme-corp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Check cert-manager logs for errors</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> logs</span><span style="color:#79B8FF;"> -n</span><span style="color:#9ECBFF;"> cert-manager</span><span style="color:#79B8FF;"> -l</span><span style="color:#9ECBFF;"> app=cert-manager</span><span style="color:#79B8FF;"> --tail=100</span><span style="color:#F97583;"> |</span><span style="color:#B392F0;"> grep</span><span style="color:#9ECBFF;"> acme-corp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Describe certificate for detailed status</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> describe</span><span style="color:#9ECBFF;"> certificate</span><span style="color:#9ECBFF;"> acme-corp-custom-tls</span><span style="color:#79B8FF;"> -n</span><span style="color:#9ECBFF;"> node-acme-corp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Check ACME challenge status (if pending)</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> challenges</span><span style="color:#79B8FF;"> -n</span><span style="color:#9ECBFF;"> node-acme-corp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Example challenge status:</span></span>
<span class="line"><span style="color:#6A737D;"># NAME                                     STATE     DOMAIN     AGE</span></span>
<span class="line"><span style="color:#6A737D;"># acme-corp-custom-tls-xxxxx-yyyyy-zzzzz   pending   acme.com   2m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># If challenge stuck, describe it:</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> describe</span><span style="color:#9ECBFF;"> challenge</span><span style="color:#79B8FF;"> -n</span><span style="color:#9ECBFF;"> node-acme-corp</span></span>
<span class="line"><span style="color:#6A737D;"># Look for: &quot;Waiting for HTTP-01 challenge propagation&quot; or similar</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="monitoring" tabindex="-1">Monitoring <a class="header-anchor" href="#monitoring" aria-label="Permalink to &quot;Monitoring&quot;">​</a></h2><div class="language-promql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">promql</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span># Count nodes with custom domains</span></span>
<span class="line"><span>sum(lynqnode_resources_ready{resource_name=~&quot;.*-ingress&quot;})</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Alert on ingress failures</span></span>
<span class="line"><span>ALERT CustomDomainIngressFailed</span></span>
<span class="line"><span>  FOR 10m</span></span>
<span class="line"><span>  WHERE lynqnode_resources_failed{resource_name=~&quot;.*-ingress&quot;} &gt; 0</span></span>
<span class="line"><span>  ANNOTATIONS {</span></span>
<span class="line"><span>    summary = &quot;Ingress failed for node {{ $labels.node }}&quot;</span></span>
<span class="line"><span>  }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="best-practices" tabindex="-1">Best Practices <a class="header-anchor" href="#best-practices" aria-label="Permalink to &quot;Best Practices&quot;">​</a></h2><ol><li><strong>Domain Verification</strong>: Always verify domain ownership before creating Ingress</li><li><strong>Rate Limiting</strong>: Implement rate limits for domain addition per node</li><li><strong>DNS TTL</strong>: Use low TTL (300s) during initial setup for faster propagation</li><li><strong>Certificate Monitoring</strong>: Monitor cert-manager for SSL provisioning issues</li><li><strong>Fallback Strategy</strong>: Keep default subdomain active even with custom domain</li><li><strong>Wildcard Support</strong>: For enterprise plans, support <code>*.custom.com</code> patterns</li></ol><h2 id="related-documentation" tabindex="-1">Related Documentation <a class="header-anchor" href="#related-documentation" aria-label="Permalink to &quot;Related Documentation&quot;">​</a></h2><ul><li><a href="/integration-external-dns.html">External DNS Integration</a> - Detailed DNS configuration</li><li><a href="/templates.html">Templates Guide</a> - Template syntax and functions</li><li><a href="/policies.html">Policies</a> - Resource lifecycle management</li><li><a href="/advanced-use-cases.html">Advanced Use Cases</a> - Other patterns</li></ul><h2 id="next-steps" tabindex="-1">Next Steps <a class="header-anchor" href="#next-steps" aria-label="Permalink to &quot;Next Steps&quot;">​</a></h2><ul><li>Implement domain verification service</li><li>Set up monitoring and alerting</li><li>Configure rate limiting</li><li>Test SSL certificate provisioning</li></ul>`,39))])}const h=e(y,[["render",u]]);export{D as __pageData,h as default};
