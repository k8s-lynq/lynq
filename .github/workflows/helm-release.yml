name: Release Helm Chart

on:
  push:
    tags:
      - 'v*'

concurrency:
  group: gh-pages-deploy
  cancel-in-progress: false  # Don't cancel in-progress deployments

permissions:
  contents: write
  packages: write
  pages: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.13.0

      - name: Extract version from tag
        id: extract_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Update Chart.yaml versions
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          sed -i "s/^version: .*/version: $VERSION/" chart/Chart.yaml
          sed -i "s/^appVersion: .*/appVersion: \"$VERSION\"/" chart/Chart.yaml
          echo "Updated Chart.yaml:"
          cat chart/Chart.yaml | grep -E "^(version|appVersion):"

      - name: Lint Helm chart
        run: |
          helm lint chart/
          echo "Chart linting passed!"

      - name: Validate chart templates
        run: |
          echo "Testing with default values..."
          helm template test-release chart/ > /dev/null

          echo "Testing with values-local.yaml..."
          helm template test-release chart/ -f chart/values-local.yaml > /dev/null

          echo "Testing with values-prod.yaml..."
          helm template test-release chart/ -f chart/values-prod.yaml > /dev/null

          echo "All template validations passed!"

      - name: Install chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        with:
          install_only: true

      - name: Package Helm chart
        run: |
          mkdir -p .cr-release-packages
          helm package chart/ -d .cr-release-packages
          echo "Packaged charts:"
          ls -lh .cr-release-packages/

      - name: Upload chart to GitHub Release
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          CR_SKIP_EXISTING: "true"
        run: |
          cr upload \
            --owner k8s-lynq \
            --git-repo lynq \
            --release-name-template "v{{ .Version }}" \
            --packages-with-index

      - name: Update release notes with changelog
        env:
          GH_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"

          # Get previous tag for changelog generation
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 v${VERSION}^ 2>/dev/null || echo "")

          # Generate release notes using GitHub API
          if [ -n "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              /repos/k8s-lynq/lynq/releases/generate-notes \
              -f tag_name="v${VERSION}" \
              -f previous_tag_name="${PREVIOUS_TAG}" \
              --jq .body)
          else
            # First release - get all commits
            CHANGELOG=$(gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              /repos/k8s-lynq/lynq/releases/generate-notes \
              -f tag_name="v${VERSION}" \
              --jq .body)
          fi

          # Create final release notes
          cat << EOF > final-notes.md
          **Lynq - Kubernetes-Native Database-Driven Automation**

          **‚ö†Ô∏è IMPORTANT:** Requires cert-manager before installation.

          \`\`\`bash
          helm repo add lynq https://k8s-lynq.github.io/lynq
          helm install lynq lynq/lynq-operator --version ${VERSION}
          \`\`\`

          [Documentation](https://lynq.sh) ‚Ä¢ [Chart README](https://github.com/k8s-lynq/lynq/blob/main/chart/README.md)

          ---

          ${CHANGELOG}
          EOF

          # Update release
          gh release edit "v${VERSION}" --notes-file final-notes.md

      - name: Update Helm repository index
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        run: |
          cr index \
            --owner k8s-lynq \
            --git-repo lynq \
            --charts-repo https://k8s-lynq.github.io/lynq \
            --index-path ./index.yaml \
            --pages-branch gh-pages \
            --release-name-template "v{{ .Version }}" \
            --push

      - name: Prepare Artifact Hub metadata
        run: |
          mkdir -p .gh-pages-artifacts
          cp chart/artifacthub-repo.yml .gh-pages-artifacts/

      - name: Deploy Artifact Hub metadata to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .gh-pages-artifacts
          keep_files: true  # Preserve Helm index, chart packages, and docs
          commit_message: "chore: update Artifact Hub metadata"

      - name: Summary
        run: |
          echo "‚úÖ Helm chart release completed successfully!"
          echo ""
          echo "üì¶ Chart version: ${{ steps.extract_version.outputs.version }}"
          echo "üè∑Ô∏è  Git tag: ${{ github.ref }}"
          echo "üì• Install command:"
          echo "   helm repo add lynq-operator https://k8s-lynq.github.io/lynq"
          echo "   helm repo update"
          echo "   helm install lynq-operator lynq-operator/lynq-operator --version ${{ steps.extract_version.outputs.version }}"
